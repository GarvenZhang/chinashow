(function(){var f=document,d=JM.getEle(".doc_area>div"),b=f.getElementById("createDocs");getData("/getAllRootFolders_action",function(i){var h=i.data,g=h.length;if(g){init(h,d,function(m){var o=m,l=JM.getEles(".doc_item"),k=JM.getEles(".doc_name"),n=JM.getEles(".doc_del"),j=JM.getEles(".doc_pic > a");JM.reverseIterator(o,function(p,r){j[p].setAttribute("data_id",r.id);k[p].setAttribute("data_id",r.id);l[p].setAttribute("data_p_id",r.parentId);k[p].value=r.fName;var q=l[p].getAttribute("data_type");if(/folder/.test(l[p].getAttribute("data_type"))){j[p].onclick=a}k[p].onblur=function(){var s=this;blur_modifyInfo(s,b,q)};l[p].onmouseover=function(s){c(n[p],s)};l[p].onmouseout=function(s){e(n[p],s)}})})}});JM.addHandler(b,"click",function(h){var g=JM.getEvent(h),i=this.getAttribute("data_id");g.stopPropagation(g);pId=i?i:0;createDoc(d,function(m,k,o,n){var j=true,l=m.getAttribute("data_type");if(/folder/.test(l)){n.onclick=a}k.onblur=function(){var p=this,q=b.getAttribute("data_id"),r=0;q?r=q:r=0;if(j){blur_createFolder(p,m,n,r,b);j=false}else{blur_modifyInfo(p,b,l)}};m.onmouseover=function(p){c(o,p)};m.onmouseout=function(p){e(o,p)}})});function c(g,i){var h=JM.getEvent(i);JM.stopPropagation(h);JM.addClass(g,"v_show")}function e(g,i){var h=JM.getEvent(i);JM.stopPropagation(h);JM.removeClass(g,"v_show")}function a(k){var l=JM.getEvent(k),j=JM.getEle(".doc_area>div"),i=JM.getEles(".doc_name"),h=f.getElementById("createDocs"),m=JM.getEles(".doc_name");JM.stopPropagation(l);var g=JM.getEles(".doc_pic > a");id=this.getAttribute("data_id");h.setAttribute("data_id",id);getEachfolderInfo(id,function(s){var t=document,o=t.getElementById("path"),u=o.getElementsByTagName("i")[0],n=t.getElementById("uploads"),q=s.data,p=q.files,r=p.length;JM.reverseIterator(g,function(v,w){w.onclick=null;m[v].onmouseover=null;m[v].onmouseout=null;i[v].onblur=null});j.innerHTML="";u.innerHTML=q.fName;JM.addClass(o,"d_show");JM.addClass(n,"d_show");n.onclick=function(A){var C=JM.getEvent(A);JM.stopPropagation(C);var z=document.getElementsByClassName("modal")[0],y=JM.getEle(".modal>div");createPicUploads(y);var B=t.getElementById("upload_pic_files"),x=t.getElementById("upload_btn"),w=t.getElementById("exit"),v=new JM_UPLOAD(B,x);v.init();x.setAttribute("f_id",id);JM.addClass(z,"d_show");w.onclick=function(F){var E=JM.getEvent(F),D=JSON.parse(v.getRes()).success_imgs;console.log(D);JM.stopPropagation(E);JM.removeClass(z,"d_show");iniCImgs(D,j)}};if(r){init(p,j,function(z){var w=z,y=JM.getEles(".doc_item"),x=JM.getEles(".doc_name"),A=JM.getEles(".doc_del"),v=JM.getEles(".doc_pic > a");JM.reverseIterator(w,function(B,C){v[B].setAttribute("data_id",C.id);x[B].setAttribute("data_id",C.id);y[B].setAttribute("data_p_id",C.parentId);x[B].value=C.fName;x[B].onblur=function(){var D=this,E=D.getAttribute("data_id");blur_operation(D,false,y[B],E)};y[B].onmouseover=function(D){c(A[B],D)};y[B].onmouseout=function(D){e(A[B],D)};if(/folder/.test(y[B].getAttribute("data_type"))){v[B].onclick=a}})})}})}})();function carryOutDeal(a,b,c){deal_item(a,b,function(e,f,g,d){if(c){c(e,f,g,d)}})}function deal_item(a,b,g){var d=JM.getEles(".doc_item"),e=JM.getEles(".doc_pic>a"),c=JM.getEles(".doc_name"),f=JM.getEles(".doc_del");JM.reverseIterator(d,function(h,j){deal(j,f[h],c[h],e[h],a,b)});if(g){g(c,d,e,f)}}function deal(f,c,e,h,a,b){var d=document.getElementById("createDocs"),g=f.getAttribute("data_type");JM.addHandler(f,"mouseover",function(i){v_show_operation(i,c)},false);JM.addHandler(f,"mouseout",function(i){v_notShow_operation(i,c)},false);JM.addHandler(e,"blur",function(){var i=this,j;a===0?j=0:j=d.getAttribute("data_id");console.log(j);blur_operation(i,b,f,j)});JM.addHandler(c,"click",function(l){var j=this,i=j.parentNode,m=i.getAttribute("data_id"),k=i.getAttribute("data_type");delelte_operation(l,m,k,i)});if(/folder/.test(g)){JM.addHandler(h,"click",function(n){var l=JM.getEvent(n),p=document,q=p.getElementById("path"),k=q.getElementsByTagName("i")[0],o=JM.getEle(".doc_area>div"),m=p.getElementById("uploads"),j=e.getAttribute("data_id"),i=e.value;JM.stopPropagation(l);d.setAttribute("data_id",j);k.innerHTML=i;o.innerHTML="";JM.addClass(q,"d_show");JM.addClass(m,"d_show");initChildFolder(j,o);JM.addHandler(m,"click",function(u){var x=JM.getEvent(u),t=document.getElementsByClassName("modal")[0],s=JM.getEle(".modal>div");JM.stopPropagation(x);createPicUploads(s);JM.addClass(t,"d_show");var v=document.getElementById("upload_pic_files"),r=document.getElementById("upload_btn");r.setAttribute("f_id",j);var w=new JM_UPLOAD(v,r);w.init();JM.addHandler(exit,"click",function(z){var y=JM.getEvent(z);JM.stopPropagation(y);JM.removeClass(t,"d_show");if(j){console.log(j);initChildFolder(j,o)}},false)});deal(f,c,e,h,a,b)})}}function createDoc(h,j,a){var k=document;var e=k.createElement("div"),f=k.createElement("div"),g=k.createElement("a"),c=k.createElement("img"),l=k.createElement("div"),d=k.createElement("form"),b=k.createElement("input"),i=k.createElement("i");if(a){c.src=a;e.setAttribute("data_type","img")}else{c.src="/images/folder.png";e.setAttribute("data_type","folder")}c.setAttribute("data_c_name","doc_pic_img");i.setAttribute("data_c_name","doc_del");d.setAttribute("enctype","application/x-www-form-urlencoded");JM.addClass(e,"doc_item");JM.addClass(f,"doc_pic");JM.addClass(b,"doc_name");JM.addClass(l,"doc_ti");JM.addClass(i,"doc_del");JM.addNodes(g,c);JM.addNodes(f,g);JM.addNodes(d,b);JM.addNodes(l,d);JM.addNodes(e,f);JM.addNodes(e,l);JM.addNodes(e,i);JM.addNodes(h,e);if(j){j(e,b,i,g)}}function init(d,e,c){var a=d,b=a.length;for(;b--;){createDoc(e)}if(c){c(d)}}function iniCImgs(b,a){var c=b;JM.reverseIterator(c,function(e,f){var d=decodeURIComponent("/"+f);createDoc(a,function(h,g,j,i){},d)})}function initCFolder(a,b){getEachfolderInfo(a,function(e){console.log(e);var f=e.data,l=f.files,j=f.imgs,d=l.length,k=f.imgs.length,h=JM.getEles('.doc_item [data_type="folder"] .doc_name'),i=JM.getEles('.doc_item [data_type="img"] .doc_name'),c=[],g=[];console.log(JM.getEles(".doc_name"));if(d){if(b){b(l)}}})}function initChildFolder(b,a){getEachfolderInfo(b,function(e){console.log(e);var f=e.data,l=f.files,j=f.imgs,d=l.length,k=f.imgs.length,h=JM.getEles('.doc_item [data_type="folder"] .doc_name'),i=JM.getEles('.doc_item [data_type="img"] .doc_name'),c=[],g=[];console.log(i);if(d){JM.reverseIterator(h,function(m,n){var o=n.value;c.push(o)});console.log(c);JM.reverseIterator(l,function(m,o){var n=o;console.log(JM.inArray(o.fName,c)<0);if(JM.inArray(o.fName,c)<0){createDoc(a,function(r,t,p,u){var s=r,q=t;s.setAttribute("data_id",n.id);q.value=n.fName})}})}if(k){JM.reverseIterator(i,function(m,n){var o=n.value;g.push(o)});JM.reverseIterator(j,function(m,n){var o=n;if(JM.inArray(o.iName,g)<0){createDoc(a,function(t,x,w,q){var r=t,u=x,s=q,v=w,p=o.id;r.setAttribute("data_id",p);u.setAttribute("data_id",p);u.value=o.iName;deal(r,v,u,s,p,false)},o.url)}})}})}function delelte_operation(f,g,a,d){var b=JM.getEvent(f),c=JSON.stringify({id:g,type:a});JM.stopPropagation(b);deleteFolder(c,d)}function blur_createFolder(c,f,g,a,b){if(/[^\s]/.test((c.value))){var e=a,d=JSON.stringify({fName:c.value.trim(),pId:e});createNewRootFolder(c,f,g,b,d,function(h){g.setAttribute("data_id",h)})}}function blur_modifyInfo(c,b,e){if(/[^\s]/.test((c.value))){var d=c.getAttribute("data_id"),a=JSON.stringify({id:d,name:c.value.trim(),type:e});modifyFolderOrImgs(c,b,a)}}function blur_operation(m,d,l,f,h,i){var j=l.getAttribute("data_type"),n=document.getElementById("createDocs");if(d){if(/[^\s]/.test((m.value))){if(i){var g=f,e=JSON.stringify({fName:m.value.trim(),pId:g});createNewRootFolder(m,l,h,n,e,function(o){i=false;h.setAttribute("data_id",o)});console.log(i)}else{var b=m.getAttribute("data_id"),a=JSON.stringify({id:b,type:j,fName:m.value.trim()});modifyFolderOrImgs(m,n,a);console.log("dsadadsdd")}}}else{if(/[^\s]/.test((m.value))){var k=m.getAttribute("data_id"),c=JSON.stringify({id:k,name:m.value.trim(),type:j});modifyFolderOrImgs(m,n,c)}}}function v_show_operation(a,c){var b=JM.getEvent(a);JM.stopPropagation(b);JM.addClass(c,"v_show")}function v_notShow_operation(a,c){var b=JM.getEvent(a);JM.stopPropagation(b);JM.removeClass(c,"v_show")}function JM_UPLOAD(a,b){this.fileInput=a;this.uploadBtn=b;this.uploadFiles=[];this.lastUploadFile=[];this.perUploadFile=[];this.zipUploadFiles={};this.fileNum=0;this.resp=""}JM_UPLOAD.prototype={constructor:JM_UPLOAD,onselect:function(g,b){var e=b,d=JM.getEle(".showPic_area>div"),a=JM.getEle(".tip>:nth-child(1)"),c=JM.getEle(".tip>:nth-child(2)");d.innerHTML="";this.zipUploadFiles={};if(a||c){JM.removeClass(a,"d_show");JM.removeClass(c,"d_show")}JM.inIterator(e,function(f,h){createPicItem(JM.createObjURL(h),h.name,function(){var k=JM.getEles(".pic_item"),i=k.length;(function j(l){if(l==i){return}k[l].setAttribute("index",l);j(++l)})(0)})})},onsucess:function(g){var h=g,b=h.status,e=JM.getEles(".pic_name"),f=JM.getEles(".pic_item span"),a=JM.getEle(".tip>:nth-child(1)");if(b){var c=h.success_imgs;JM.inIterator(e,function(d,j){if(JM.inArray(j.innerHTML,c)>-1){JM.addClass({upload_success:f[d],v_show:f[d]})}else{JM.addClass({upload_false:f[d],v_show:f[d]});JM.addClass(a,"show")}})}else{JM.inIterator(e,function(d,j){if(JM.inArray(j.innerHTML,c)>-1){JM.addClass({upload_success:f[d],v_show:f[d]})}else{JM.addClass({upload_false:f[d],v_show:f[d]});JM.addClass(a,"show")}})}},onfail:function(b){console.log(b);var a=JM.getEle(".tip>:nth-child(2)");JM.addClass(a,"show")},ondelete:function(a){this.fn_deleteFiles(a,function(c,b){console.info("当前删除了此文件：");console.info(c);console.info("当前剩余的文件：");console.info(b)})},getFile:function(){return this.zipUploadFiles},getRes:function(){return this.resp},fn_dragOver:function(b){var a=JM.getEvent(b);JM.stopPropagation(a);JM.preventDefault(a);return this},fn_filterFiles:function(c){var d=c,a=[];for(var b in d){if(/\d+/.test(b)){a.push(d[b])}}return a},fn_getFiles:function(g){var f=JM.getEvent(g),b=this;this.fn_dragOver(g);var d=JM.getTarget(f).files||f.dataTransfer.files;b.lastUploadFile=this.uploadFiles;this.uploadFiles=this.uploadFiles.concat(this.fn_filterFiles(d));var c=[],a=[],h=[];JM.inIterator(this.lastUploadFile,function(e,j){a.push(j.name)});JM.inIterator(this.uploadFiles,function(e,j){h.push(j.name)});JM.inIterator(h,function(e,j){if(JM.inArray(j,a)<0){c.push(b.uploadFiles[e])}});this.uploadFiles=c;this.fn_dealFiles();return true},fn_dealFiles:function(){var b=this,a;JM.inIterator(this.uploadFiles,function(f,g){g.index=b.fileNum;b.fileNum++});var c=this.uploadFiles;this.perUploadFile=this.perUploadFile.concat(this.uploadFiles);this.uploadFiles=this.lastUploadFile.concat(this.uploadFiles);var e=this.uploadFiles.length;if(e>10){this.uploadFiles=this.uploadFiles.splice(0,10);e=10}this.onselect(c,this.uploadFiles);(function d(j){if(j==e){return}var l=b.uploadFiles[j],k=l.type,h=l.name,g=new FileReader();g.readAsDataURL(l);g.onload=function(n){var m=JM.getEvent(n),i=JM.getTarget(m).result,f=new Image();f.src=i;f.onload=function(){var p=document.createElement("canvas"),s=1;p.width=350;p.height=400;if(p.getContext){var o=p.getContext("2d");o.drawImage(this,0,0,p.width,p.height);var q=p.toDataURL(k,0.8),r=q.replace(/^data:image\/\w+;base64,/,"");b.zipUploadFiles[h]=r}}};d(++j)})(0);return this},fn_deleteFiles:function(b,e){var a=this,c=[],d=a.perUploadFile[b];JM.inIterator(a.uploadFiles,function(f,g){if(d!=g){c.push(g)}});this.uploadFiles=c;if(e){e(d,a.uploadFiles)}return true},fn_uploadFiles:function(){var b=this,a=b.uploadFiles.length,e=new FormData(),d=JM.createXHR();if(a>0){JM.inIterator(this.uploadFiles,function(f,g){e.append("pic",g)});e.append("zipImgs",JSON.stringify(b.zipUploadFiles));var c=b.uploadBtn.getAttribute("f_id");e.append("f_id",c);JM.addHandler(d,"load",function(){JM.inIterator(b.uploadFiles,function(f,g){b.fn_deleteFiles(g.index,false)});b.onsucess(JSON.parse(d.responseText));b.resp=d.responseText;if(b.uploadFiles.length==0){console.log("全部完成")}},false);JM.addHandler(d,"error",function(){console.log("错误")},false);d.open("POST","/uploadImgs_action",false);d.send(e)}},init:function(){var a=this;if(a.fileInput){JM.addHandler(this.fileInput,"change",function(f){a.fn_getFiles(f);var d=JM.getEles(".pic_delete"),c=JM.getEles(".pic_item"),b=JM.getEle(".showPic_area>div");if(d){JM.inIterator(d,function(e,g){JM.addHandler(g,"click",function(k){var j=JM.getEvent(k),i=e;JM.stopPropagation(j);var h=JM.getPreChild(g).innerHTML;JM.inIterator(a.uploadFiles,function(l,m){if(m.name==h){a.ondelete(m.index);JM.removeNodes(b,c[i])}})})})}},false)}if(a.uploadBtn){JM.addHandler(this.uploadBtn,"click",function(b){JM.stopPropagation(JM.getEvent(b));a.fn_uploadFiles()},false)}}};function createPicUploads(b){var a='<div id="uploadPics"><div class="upload_area"><div><div><div class="chooseFile">上传照片</div><form enctype="multipart/form-data" id="up"><input type="file" multiple="multiple" name="picture" id="upload_pic_files"></form></div></div></div><div class="infos_area clearfix"><p>温馨提示：一次最多上传10张图片。</p><div><button type="button" id="upload_btn">开始上传</button></div></div><div class="showPic_area"><div class="clearfix"></div></div><div class="tip"><p>图片已存在</p><p>图片上传失败</p></div></div>';b.innerHTML=a}function createPicItem(a,c,h){var j=document,b=JM.getEle(".showPic_area>div"),f=j.createElement("div"),d=j.createElement("div"),e=j.createElement("img"),g=j.createElement("span"),k=j.createElement("div"),i=j.createElement("p"),l=j.createElement("i");e.src=a;i.innerHTML=c;JM.addClass(f,"pic_item");JM.addClass({pic_info:k,clearfix:k});JM.addClass(i,"pic_name");JM.addClass(l,"pic_delete");JM.addHandler(f,"mouseover",function(){JM.addClass(k,"v_show")},false);JM.addHandler(f,"mouseout",function(){JM.removeClass(k,"v_show")},false);JM.addNodes(d,e);JM.addNodes(k,i);JM.addNodes(k,l);JM.addNodes(f,d);JM.addNodes(f,g);JM.addNodes(f,k);JM.addNodes(b,f);if(h){h()}}function getData(a,b){JM.ajax(a,"get",false,null,function(d){var c=JSON.parse(d.responseText);if(b){b(c)}})}function createNewRootFolder(d,c,f,a,b,e){JM.ajax("/addFolder_action","post",false,b,function(k){var j=JSON.parse(k.responseText),l=j.newId,g=j.pId,i=j.fName,h=JM.getEles(".tips>p")[1];d.setAttribute("data_pId",g);d.setAttribute("data_id",l);c.setAttribute("data_id",l);f.setAttribute("data_id",l);d.setAttribute("data_name",i);if(j.status){if(e){e(l)}a.disabled=false;JM.removeClass(h,"show")}else{JM.addClass(h,"show");a.disabled=true}})}function modifyFolderOrImgs(c,a,b){JM.ajax("/modifyFolderOrImgs_action","post",false,b,function(f){var e=JSON.parse(f.responseText),d=JM.getEles(".tips>p")[1];if(e.status){JM.removeClass(d,"show");a.disabled=false;c.setAttribute("data_name",JSON.parse(b).fName);console.log(1)}else{a.disabled=true;JM.addClass(d,"show")}})}function deleteFolder(b,a){JM.ajax("/deleteFolderAndImg_action","post",false,b,function(e){var c=JM.getEle("#doc_area > div"),d=JSON.parse(e.responseText).status;if(!d){console.log("删除文件夹失败")}JM.removeNodes(c,a)})}function getImgs(b){var a=JSON.stringify({fId:b});JM.ajax("/getimgs_action","post",false,a,function(c){a=JSON.parse(c.responseText)});return a}function getEachfolderInfo(c,b){var a=JSON.stringify({id:c});JM.ajax("/getEachfolderInfo_action","post",false,a,function(f){var e=JSON.parse(f.responseText);if(b){b(e)}})};