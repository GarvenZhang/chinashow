var mysql=require("mysql"),formidable=require("formidable"),file=require("./file.js"),path=require("path"),fs=require("fs");var pool=mysql.createPool({host:"localhost",port:3306,database:"china",user:"root",password:"hellojm"});exports.register=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！")}else{console.log("连接数据库成功!");c.query("SELECT MAX(id) AS MAX_ID FROM ??",["user"],function(g,f){if(g){console.log("查询表失败！"+g)}else{var e=f[0].MAX_ID;b.on("data",function(k){var l=JSON.parse(k.toString()),i=l.name,h=l.password,j=l.phoneNum;c.query("SELECT ? FROM ?? WHERE ??=?",["name","user","name",i],function(o,m){if(o){console.log("查询表失败！"+o)}else{console.log(m);var n=m.length;if(n){a.send({status:false})}else{c.query("INSERT INTO ?? set id=?,name=?,password=?,phone=?",["user",++e,i,h,j],function(q,p){if(q){console.log("插入表失败:"+q)}else{a.send({status:true})}})}}})})}})}})};exports.login=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{b.on("data",function(g){var h=JSON.parse(g.toString()),f=h.name,e=h.password;c.query("SELECT ??,?? FROM ?? WHERE ??=? AND ??=?",["name","password","user","name",f,"password",e],function(k,i){if(k){console.log("查询表失败！"+k)}else{var j=i.length;console.log(j);if(j){a.send({status:true})}else{a.send({status:false})}}})})}})};exports.modifyPsw=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{b.on("data",function(g){var h=JSON.parse(g.toString()),f=h.name,e=h.password;c.query("UPDATE ?? SET ??=? WHERE ??=?",["user","password",e,"name",f],function(k,j){if(k){console.log("更新表失败！"+k)}else{var i=j.affectedRows;if(i){a.send({status:true})}else{a.send({status:false})}}})})}})};exports.addNewFolder=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{console.log("连接数据库成功！");c.query("SELECT MAX(id) AS max_id FROM file",function(f,e){if(f){console.log("查询表失败！"+f)}else{console.log("查询表成功!");var g=e[0].max_id;if(g){++g}else{g=1}b.on("data",function(k){var h=JSON.parse(k.toString()),i=h.pId,j=h.fName;console.log(h);if(i==0){c.query("SELECT id,fName,parentId FROM file WHERE fName=? AND id=parentId",[j],function(n,m){if(n){console.log("查询表失败"+n)}else{console.log("查询表成功");var l=m.length;if(l==0){c.query("INSERT INTO file set id=?,fName=?,parentId=?",[g,h.fName,g],function(p,o){if(p){console.log("插入表失败！")}else{console.log("插入表成功！");a.send({newId:g,pId:g,fName:j,status:true})}})}else{a.send({status:false})}}})}else{c.query("SELECT id,fName,parentId FROM file WHERE fName=? AND parentId=? AND parentId!=id",[j,i],function(n,m){if(n){console.log("查询表失败"+n)}else{console.log("查询表成功");var l=m.length;if(l==0){c.query("INSERT INTO file set id=?,fName=?,parentId=?",[g,j,i],function(p,o){if(p){console.log("插入表失败！")}else{console.log("插入表成功！");a.send({newId:g,pId:i,status:true})}})}else{a.send({status:false})}}})}})}})}})};exports.modifyFolderInfo=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{console.log("连接数据库成功！");b.on("data",function(h){var e=JSON.parse(h.toString()),i=e.id,g=e.name,f=e.type;if(/folder/.test(f)){c.query("SELECT ?? FROM ?? WHERE ??=?",["parentId","file","id",i],function(l,k){if(l){console.log("查询file表失败!"+l)}else{var j=k[0].parentId;if(i==j){c.query("SELECT ?? FROM ?? WHERE ??=?? AND ??=?",["fName","file","id","parentId","fName",g],function(o,n){if(o){console.log("查询表file失败！"+o)}else{var m=n.length;if(m==0){c.query("UPDATE ?? set ??=? WHERE ??=?",["file","fName",g,"id",i],function(q,p){if(q){console.log("更新file表失败！"+q)}else{console.log("更新file表成功！");a.send({status:true})}})}else{a.send({status:false})}}})}else{c.query("SELECT ?? FROM ?? WHERE ??=? AND ??!=?? AND ??=?  ",["fName","file","parentId",j,"parentId","id","fName",g],function(o,n){if(o){console.log("查询表file失败！"+o)}else{var m=n.length;if(m==0){c.query("UPDATE ?? set ??=? WHERE ??=?",["file","fName",g,"parentId",i],function(q,p){if(q){console.log("更新表file失败！"+q)}else{console.log("更新file表成功！");a.send({status:true})}})}else{a.send({status:false})}}})}}})}else{c.query("SELECT ?? FROM ?? WHERE ??=?",["f_id","imgs","id",i],function(l,j){if(l){console.log("查询表失败！"+l)}else{console.log(j);var k=j[0].f_id;c.query("SELECT ?? FROM ?? WHERE ??=? AND ??=?",["iName","imgs","f_id",k,"iName",g],function(o,n){if(o){console.log("查询表失败！"+o)}else{var m=n.length;if(m){a.send({status:false})}else{c.query("SELECT baseUrl,url FROM imgs WHERE id=?",[i],function(v,t){if(v){console.log("查询表错误!"+v)}else{var q=t[0].baseUrl,s=t[0].url;var p="/"+i+"-"+g+".txt",r="/"+i+"-"+g;c.query("UPDATE ?? SET iName=?,baseUrl=?,url=? WHERE id=?",["imgs",g,p,r,i],function(w,u){if(w){console.log("更新表失败！"+w)}else{file.modifyImgSrc(s,r,q,p)}})}})}}})}})}})}})};exports.deleteFolderOrImg=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{console.log("连接数据库成功！");b.on("data",function(g){var e=JSON.parse(g.toString()),h=e.id,f=e.type;if(/folder/.test(f)){c.query("SELECT url,baseUrl FROM imgs WHERE f_id=?",[h],function(l,j){if(l){console.log("查询表失败！"+l)}else{var k=j,i=k.length;if(i){file.deleteAllImgSrc(k,function(){deleteAllPics(c,h,a)})}else{deleteAllPics(c,h,a)}}})}else{c.query("SELECT url,baseUrl FROM imgs WHERE id=?",[h],function(n,k){if(n){console.log("查询表失败！"+n)}else{var m=k,i=m.length,j=m[0].url,l=m[0].baseUrl;if(i){file.deleteImgSrc(j,l,function(){deleteSinglePic(c,h,a)})}else{deleteSinglePic(c,h,a)}}})}})}})};exports.getEachfolderInfo=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{console.log("连接数据库成功！");getEachFolderInfo(b,a,c,function(e){a.send({data:e,status:true})})}})};exports.getAllRootFolders=function(b,a){getRootInfos(function(c){a.send({data:c,status:true})})};exports.showRootData=function(b,a,c){getRootInfos(function(d){if(c){c(d[d.length-1].fName)}})};exports.modifyImgInfo=function(b,a){pool.getConnection(function(d,c){if(d){console.log(d)}else{console.log("连接数据库成功!");b.on("data",function(e){var f=JSON.parse(e.toString()).id;c.query("")})}})};exports.judeFolderInfo=function(b,a){pool.getConnection(function(d,c){if(d){console.log(d)}else{console.log("连接数据库成功!");b.on("data",function(f){var e=JSON.parse(f.toString()).fName;c.query("SELECT fName FROM file WHERE fName=? AND id=parentId",[e],function(i,h){var g=h.length;console.log(g);if(g>0){a.send({status:false})}else{a.send({status:true})}})})}})};exports.uploadImgs=function(b,a){pool.getConnection(function(f,c){if(f){console.log("连接数据库失败!"+f)}else{console.log("连接数据库成功!");var e=new formidable.IncomingForm(),d=[];e.multiples=true;e.keepExtensions=true;e.uploadDir=path.normalize(__dirname+"/../uploads");e.on("file",function(g,h){d.push(h)});e.parse(b,function(k,g,j){if(k){}var l=JSON.parse(g.zipImgs),i=g.f_id,h={};c.query("SELECT MAX(id) AS MAX_ID_IMGS FROM imgs",function(s,q){if(s){console.log(s)}else{var p=d.length,o=q[0].MAX_ID_IMGS,r=[],m=[],n=[],t=[];c.query("SELECT iName FROM imgs WHERE f_id=?",[i],function(y,w){if(y){console.log("查找错误:"+y)}else{var x=w,v=x.length;for(;v--;){r.push(x[v].iName)}for(;p--;){m.push({name:d[p].name,path:d[p].path})}reverseIterator(m,function(z,A){if(inArray(A.name,r)<0){t.push(A.name)}else{n.push(A.name)}});var u=m.length;if(u>0){reverseIterator(t,function(A,C){h[C]=l[C];file.createSmPic(h,i);var B=path.normalize(__dirname+"/../uploads/"+i+"-"+C),z="/"+i+"-"+C,D=new Date();c.query("INSERT INTO imgs set id=?,iName=?,f_id=?,url=?,baseUrl=?,iTime=?",[++o,C,i,z,z,D],function(G,F){if(G){console.log("err"+G)}else{for(var E in m){if(m[E].name==C){var H=m[A].path;fs.rename(H,B,function(I){if(I){console.log("错误："+I)}})}}}})});a.send({success_imgs:t,fail_imgs:n,status:true})}else{a.send({status:false})}}})}})})}})};exports.getImgs=function(b,a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{b.on("data",function(e){var f=JSON.parse(e.toString()),g=f.fId;c.query("SELECT iName,url FROM imgs WHERE f_id=?",[g],function(j,h){if(j){console.log("读取表失败！"+j)}else{var i=h;a.send({data:i})}})})}})};function getRootFImgs(a,b,c){a.query("SELECT ??,??,?? FROM imgs WHERE f_id=?",["id","iName","iTime",b],function(h,f){if(h){console.log("查询表失败！"+h)}else{console.log("查询表成功");var e=[],d=f;if(d.length>0){(function g(j){if(j==d.length){return}e.push(d[j]);g(j+1)})(0)}else{e=[]}if(c){c(e)}}})}function getRootFFiles(a,b,c){a.query("SELECT id,fName FROM file WHERE parentId=? AND NOT parentId=id",[b],function(g,e){if(g){console.log("查询表失败！")}else{console.log("查询表成功！");var d=[];root_doc=e;if(root_doc.length>0){(function f(h){if(h==root_doc.length){return}d.push({id:root_doc[h].id,fName:root_doc[h].fName});f(h+1)})(0)}else{d=[]}if(c){c(d)}}})}function deleteImg(a,c,b){a.query("DELETE FROM imgs WHERE f_id=?",[c],function(e,d){if(e){console.log(e)}else{console.log("删除图片成功！");if(b){b(e)}}})}function deleteAllPics(a,c,b){a.query("CALL removeALL(?)",[c],function(e,d){if(e){console.log("删除失败！"+e);b.send({status:false})}else{b.send({status:true})}})}function deleteSinglePic(a,c,b){a.query("DELETE FROM ?? WHERE id=?",["imgs",c],function(e,d){if(e){console.log("删除失败！"+e);b.send({status:false})}else{b.send({status:true})}})}function getRootInfos(a){pool.getConnection(function(d,c){if(d){console.log("连接数据库失败！"+d)}else{console.log("连接数据库成功！");var b=[];c.query("SELECT id,fName,parentId FROM file WHERE parentId=id",function(h,f){if(h){console.log("查询数据失败！"+h)}else{var g=f,e=g.length;if(e){reverseIterator(g,function(j,l){var k=l;c.query("SELECT baseurl FROM imgs WHERE f_id=? ORDER BY iTime DESC",[k.id],function(o,n){if(o){console.log(o)}else{var m=n,i=m.length;if(i>0){b.push({id:k.id,fName:k.fName,parentId:k.parentId,baseUrl:m[0].baseurl})}else{b.push({id:k.id,fName:k.fName,parentId:k.parentId,baseUrl:" "})}if(j==e-1){if(a){a(b)}}}})})}else{if(a){a(b)}}}})}})}function getEachFolderInfo(c,b,a,d){c.on("data",function(f){var e=JSON.parse(f.toString()),g=e.id;a.query("CALL getEachFolderInfo(?)",[g],function(k,l){if(k){console.log("查询表失败！"+k)}else{var h=l,j=h[0][0].num1,o=h[1][0].fName,p=h[1][0].parentId,m=h[3],i=h[2],n=i.length;arr=[];if(n){--n;reverseIterator(i,function(q,r){console.log(r.id);a.query("SELECT baseUrl FROM imgs WHERE f_id=? ORDER BY iTime DESC",[r.id],function(v,t){if(v){console.log("查询表错误！"+v)}else{var u=t,s=u.length;if(s){arr.push({id:r.id,fName:r.fName,parentId:r.parentId,baseUrl:u[0].baseUrl})}else{arr.push({id:r.id,fName:r.fName,parentId:r.parentId,baseUrl:""})}if(q==n){if(d){d({id:j,fName:o,pId:p,imgs:m,files:arr})}}}})})}else{if(d){d({id:j,fName:o,pId:p,imgs:m,files:i})}}}})})}function inArray(f,c,e){var b,d=c.reverse();if(c){b=d.length;e=e?(e<0?Math.max(0,b+e):e):0;for(;e<b;e++){if(d[e]==f){return e}}}return -1}function reverseIterator(c,d){for(var b=0,a=c.length;b<a;b++){d(b,c[b])}};